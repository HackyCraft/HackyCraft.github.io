<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama & Gradio Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1a73e8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .mic-button.active {
            background-color: #ef4444; /* red-500 */
        }
        .mic-button.active:hover {
            background-color: #dc2626; /* red-600 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="container bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-200 flex flex-col h-[95vh] w-full">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">TTS ChatBot by HackyCraft</h1>
            <p class="text-gray-500 text-sm md:text-base mt-1">Talk to an AI, powered by Ollama and Kokoro TTS.</p>
        </div>

        <!-- Settings Section -->
        <details class="bg-gray-50 p-4 rounded-xl mb-4 border border-gray-200" open>
            <summary class="text-lg font-semibold text-gray-700 cursor-pointer">Settings</summary>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="ollama-server" class="block text-xs font-medium text-gray-600 mb-1">Ollama Server</label>
                    <input type="text" id="ollama-server" value="http://204.186.71.141:8086" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="ollama-model" class="block text-xs font-medium text-gray-600 mb-1">Ollama Model</label>
                    <input type="text" id="ollama-model" value="huihui_ai/gemma3-abliterated:12b" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="gradio-server" class="block text-xs font-medium text-gray-600 mb-1">Gradio Server</label>
                    <input type="text" id="gradio-server" value="https://48e2058f67ea319c1f.gradio.live/" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <div class="mt-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">AI Persona</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="ai-name" class="block text-xs font-medium text-gray-600 mb-1">AI Name</label>
                        <input type="text" id="ai-name" value="Vivian" placeholder="Enter a name for the AI" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="ai-prompt" class="block text-xs font-medium text-gray-600 mb-1">AI Prompt</label>
                        <input type="text" id="ai-prompt" value="You are a helpful human assistant named Vivian. Responses will be in plain text, with complete sentences including punctuation. You will not respond with emojis, bullets or numbered lists" placeholder="Enter a prompt for the AI's persona" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="voice-select" class="block text-xs font-medium text-gray-600 mb-1">TTS Voice</label>
                    <select id="voice-select" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="af_heart">af_heart</option>
                        <option value="af_bella" selected>af_bella</option>
                        <option value="af_nicole">af_nicole</option>
                        <option value="af_aoede">af_aoede</option>
                        <option value="af_kore">af_kore</option>
                        <option value="af_sarah">af_sarah</option>
                        <option value="af_nova">af_nova</option>
                        <option value="af_sky">af_sky</option>
                        <option value="af_alloy">af_alloy</option>
                        <option value="af_jessica">af_jessica</option>
                        <option value="af_river">af_river</option>
                        <option value="am_michael">am_michael</option>
                        <option value="am_fenrir">am_fenrir</option>
                        <option value="am_puck">am_puck</option>
                        <option value="am_echo">am_echo</option>
                        <option value="am_eric">am_eric</option>
                        <option value="am_liam">am_liam</option>
                        <option value="am_onyx">am_onyx</option>
                        <option value="am_santa">am_santa</option>
                        <option value="am_adam">am_adam</option>
                        <option value="bf_emma">bf_emma</option>
                        <option value="bf_isabella">bf_isabella</option>
                        <option value="bf_alice">bf_alice</option>
                        <option value="bf_lily">bf_lily</option>
                        <option value="bm_george">bm_george</option>
                        <option value="bm_fable">bm_fable</option>
                        <option value="bm_lewis">bm_lewis</option>
                        <option value="bm_daniel">bm_daniel</option>
                    </select>
                </div>
                <div>
                    <label for="speed-slider" class="block text-xs font-medium text-gray-600 mb-1">
                        Speed: <span id="speed-value">1.0</span>
                    </label>
                    <input type="range" id="speed-slider" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full">
                </div>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="max-tokens-slider" class="block text-xs font-medium text-gray-600 mb-1">
                        Max Tokens: <span id="max-tokens-value">1024</span>
                    </label>
                    <input type="range" id="max-tokens-slider" min="128" max="2048" step="128" value="1024" class="w-full">
                </div>
                <div>
                    <label for="context-length-slider" class="block text-xs font-medium text-gray-600 mb-1">
                        Context Length: <span id="context-length-value">4096</span>
                    </label>
                    <input type="range" id="context-length-slider" min="512" max="8192" step="512" value="4096" class="w-full">
                </div>
                <div>
                    <label for="temperature-slider" class="block text-xs font-medium text-gray-600 mb-1">
                        Temperature: <span id="temperature-value">0.8</span>
                    </label>
                    <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="0.8" class="w-full">
                </div>
                <div>
                    <label for="top-k-slider" class="block text-xs font-medium text-gray-600 mb-1">
                        Top K: <span id="top-k-value">40</span>
                    </label>
                    <input type="range" id="top-k-slider" min="1" max="100" step="1" value="40" class="w-full">
                </div>
                <div>
                    <label for="top-p-slider" class="block text-xs font-medium text-gray-600 mb-1">
                        Top P: <span id="top-p-value">0.9</span>
                    </label>
                    <input type="range" id="top-p-slider" min="0" max="1" step="0.05" value="0.9" class="w-full">
                </div>
            </div>
        </details>

        <!-- Chat messages container -->
        <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 p-4 space-y-4 rounded-xl border border-gray-300 bg-gray-50">
            <!-- Messages will be injected here -->
        </div>

        <!-- Status and Audio Player -->
        <div class="flex flex-col items-center justify-center mt-auto">
            <p id="status-message" class="text-sm md:text-base text-gray-600 font-medium mb-2"></p>
            <audio id="audio-player" controls class="hidden w-full rounded-full shadow-md"></audio>
        </div>

        <!-- Chat Input Form -->
        <form id="chat-form" class="mt-4 flex gap-2">
            <input type="text" id="chat-input" placeholder="Ask me anything..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm">
            <button type="submit" id="send-button" class="flex-shrink-0 flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                <span id="button-text">Send</span>
                <div id="loading-spinner" class="loading-spinner ml-2 hidden"></div>
            </button>
            <button type="button" id="mic-button" class="mic-button flex-shrink-0 flex items-center justify-center bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl transition duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5z" />
                    <path d="M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 1 1-13.5 0v-1.5A.75.75 0 0 1 6 10.5z" />
                    <path d="M11.25 18a.75.75 0 0 1 .75.75v2.25h2.25a.75.75 0 0 1 0 1.5h-5.25a.75.75 0 0 1 0-1.5h2.25v-2.25a.75.75 0 0 1 .75-.75z" />
                </svg>
            </button>
            <button type="button" id="clear-button" class="flex-shrink-0 flex items-center justify-center bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 rounded-xl transition duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">Clear Chat</button>
        </form>
    </div>

    <!-- Gradio Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.js";
        
        const ollamaServerInput = document.getElementById('ollama-server');
        const ollamaModelInput = document.getElementById('ollama-model');
        const gradioServerInput = document.getElementById('gradio-server');
        const voiceSelect = document.getElementById('voice-select');
        const speedSlider = document.getElementById('speed-slider');
        const speedValueSpan = document.getElementById('speed-value');
        const aiNameInput = document.getElementById('ai-name');
        const aiPromptInput = document.getElementById('ai-prompt');
        const maxTokensSlider = document.getElementById('max-tokens-slider');
        const maxTokensValueSpan = document.getElementById('max-tokens-value');
        const contextLengthSlider = document.getElementById('context-length-slider');
        const contextLengthValueSpan = document.getElementById('context-length-value');
        const temperatureSlider = document.getElementById('temperature-slider');
        const temperatureValueSpan = document.getElementById('temperature-value');
        const topKSlider = document.getElementById('top-k-slider');
        const topKValueSpan = document.getElementById('top-k-value');
        const topPSlider = document.getElementById('top-p-slider');
        const topPValueSpan = document.getElementById('top-p-value');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const sendButton = document.getElementById('send-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusMessage = document.getElementById('status-message');
        const audioPlayer = document.getElementById('audio-player');
        const clearButton = document.getElementById('clear-button');
        const micButton = document.getElementById('mic-button');

        let conversationHistory = [];
        let abortController = null;
        let isListening = false;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Only get one result at a time
            recognition.interimResults = false; // We only want final results
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                console.log('Voice recognition started.');
                isListening = true;
                micButton.classList.add('active');
                statusMessage.textContent = 'Listening...';
            };

            recognition.onend = () => {
                console.log('Voice recognition ended.');
                isListening = false;
                micButton.classList.remove('active');
                statusMessage.textContent = 'Processing voice input...';
                if (chatInput.value.trim() !== '') {
                    // Automatically submit the form after a pause
                    chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
                console.log('Transcript:', transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                statusMessage.textContent = `Error with speech recognition: ${event.error}`;
                isListening = false;
                micButton.classList.remove('active');
            };
        } else {
            micButton.disabled = true;
            micButton.title = "Speech recognition is not supported in this browser.";
            console.warn("Speech Recognition API not supported in this browser.");
        }

        micButton.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        speedSlider.addEventListener('input', (event) => {
            speedValueSpan.textContent = event.target.value;
        });

        maxTokensSlider.addEventListener('input', (event) => {
            maxTokensValueSpan.textContent = event.target.value;
        });

        contextLengthSlider.addEventListener('input', (event) => {
            contextLengthValueSpan.textContent = event.target.value;
        });
        
        temperatureSlider.addEventListener('input', (event) => {
            temperatureValueSpan.textContent = event.target.value;
        });

        topKSlider.addEventListener('input', (event) => {
            topKValueSpan.textContent = event.target.value;
        });

        topPSlider.addEventListener('input', (event) => {
            topPValueSpan.textContent = event.target.value;
        });


        function addMessage(text, isUser, name) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('flex', 'flex-col', 'max-w-[85%]', 'break-words');
            
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('text-xs', 'font-semibold', 'text-gray-500', 'mb-1');
            nameSpan.textContent = isUser ? "You" : (name || "AI");
            messageContainer.appendChild(nameSpan);

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('p-3', 'rounded-xl', 'shadow-sm');

            if (isUser) {
                messageContainer.classList.add('ml-auto', 'items-end');
                messageDiv.classList.add('bg-blue-500', 'text-white');
            } else {
                messageContainer.classList.add('mr-auto', 'items-start');
                messageDiv.classList.add('bg-gray-200', 'text-gray-800');
            }

            messageDiv.textContent = text;
            messageContainer.appendChild(messageDiv);
            chatMessagesDiv.appendChild(messageContainer);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        async function generateAudio(textContent) {
            audioPlayer.classList.add('hidden');
            statusMessage.textContent = "Generating audio...";
            
            try {
                const serverAddress = gradioServerInput.value;
                const selectedVoice = voiceSelect.value;
                const selectedSpeed = parseFloat(speedSlider.value);
                
                const app = await Client.connect(serverAddress);
                statusMessage.textContent = "API connection successful. Generating audio...";

                const result = await app.predict(
                    "/generate_all", {
                        text: textContent,
                        voice: selectedVoice,
                        speed: selectedSpeed,
                        use_gpu: true,
                    }
                );
                
                if (result.error) {
                    statusMessage.textContent = `API Error: ${result.error}`;
                    console.error("Gradio API returned an error:", result.error);
                }
                else if (result.data && result.data.length > 0 && (result.data[0].blob || result.data[0].url)) {
                    const audioData = result.data[0];
                    let audioUrl;

                    if (audioData.is_stream && Hls.isSupported()) {
                        audioUrl = audioData.url;
                        const hls = new Hls();
                        hls.loadSource(audioUrl);
                        hls.attachMedia(audioPlayer);
                        statusMessage.textContent = "Audio stream generated successfully. Playing...";
                    }
                    else if (audioData.blob) {
                        audioUrl = URL.createObjectURL(audioData.blob);
                        audioPlayer.src = audioUrl;
                        statusMessage.textContent = "Audio file generated successfully. Playing...";
                    } else {
                        statusMessage.textContent = "Error: Unexpected API response. No audio data found.";
                        console.error("Unexpected API response:", result);
                    }
                    
                    audioPlayer.classList.remove('hidden');
                    audioPlayer.play().catch(e => {
                        console.warn("Autoplay was prevented. User must manually play the audio.", e);
                        statusMessage.textContent = "Audio ready. Please press play.";
                    });
                } else {
                    statusMessage.textContent = "Error: Unexpected API response. No audio data found.";
                    console.error("Unexpected API response:", result);
                }
            } catch (error) {
                console.error("Error generating audio:", error);
                statusMessage.textContent = `Error: ${error.message}`;
            }
        }
        
        async function getOllamaResponse() {
            const botName = aiNameInput.value || "AI";
            addMessage("", false, botName);
            const botMessagePlaceholder = chatMessagesDiv.lastElementChild.querySelector('div');

            statusMessage.textContent = "Thinking...";
            
            const ollamaServer = ollamaServerInput.value;
            const ollamaModel = ollamaModelInput.value;
            const aiPrompt = aiPromptInput.value;

            const messages = [{ role: 'system', content: aiPrompt }].concat(conversationHistory);

            // Get values from new sliders
            const maxTokens = parseInt(maxTokensSlider.value);
            const contextLength = parseInt(contextLengthSlider.value);
            const temperature = parseFloat(temperatureSlider.value);
            const topK = parseInt(topKSlider.value);
            const topP = parseFloat(topPSlider.value);

            abortController = new AbortController();
            const signal = abortController.signal;

            try {
                const response = await fetch(`${ollamaServer}/api/chat`, {
                    method: 'POST',
                    body: JSON.stringify({
                        model: ollamaModel,
                        messages: messages,
                        stream: true,
                        // Add common Ollama options from sliders
                        options: {
                            num_predict: maxTokens,
                            num_ctx: contextLength,
                            temperature: temperature,
                            top_k: topK,
                            top_p: topP
                        }
                    }),
                    signal
                });
                
                if (!response.ok) {
                    throw new Error(`Ollama API request failed with status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() !== '') {
                            const data = JSON.parse(line);
                            if (data.message && data.message.content) {
                                fullResponse += data.message.content;
                                botMessagePlaceholder.textContent = fullResponse;
                                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                            }
                        }
                    }
                }
                
                conversationHistory.push({ role: 'assistant', content: fullResponse });
                statusMessage.textContent = "Response received.";
                await generateAudio(fullResponse);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Fetch aborted.');
                } else {
                    console.error("Error with Ollama API:", error);
                    botMessagePlaceholder.textContent = `Error: ${error.message}`;
                    statusMessage.textContent = `Error: ${error.message}`;
                }
            } finally {
                sendButton.disabled = false;
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = "Send";
            }
        }

        chatForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const userPrompt = chatInput.value.trim();

            if (!userPrompt) return;

            sendButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = "Thinking...";
            statusMessage.textContent = "";
            audioPlayer.classList.add('hidden');
            
            addMessage(userPrompt, true);
            conversationHistory.push({ role: 'user', content: userPrompt });
            chatInput.value = '';
            
            await getOllamaResponse();
        });

        clearButton.addEventListener('click', () => {
            conversationHistory = [];
            chatMessagesDiv.innerHTML = '';
            statusMessage.textContent = "Chat history cleared.";
            audioPlayer.classList.add('hidden');
        });

    </script>
</body>
</html>
